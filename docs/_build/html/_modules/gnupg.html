

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>gnupg &mdash; python-gnupg 0.4.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.4.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/theme_extras.js"></script>
    <link rel="top" title="python-gnupg 0.4.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="../index.html">
          <span>python-gnupg 0.4.0 documentation</span></a></h1>
        <h2 class="heading"><span>gnupg</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        <a class="uplink" href="../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for gnupg</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c">#-*- encoding: utf-8 -*-</span>
<span class="c">#</span>
<span class="c"># This file is part of python-gnupg, a Python wrapper around GnuPG.</span>
<span class="c"># Copyright © 2013 Isis Lovecruft</span>
<span class="c">#           © 2008-2012 Vinay Sajip</span>
<span class="c">#           © 2005 Steve Traugott</span>
<span class="c">#           © 2004 A.M. Kuchling</span>
<span class="c">#</span>
<span class="c"># This program is free software: you can redistribute it and/or modify</span>
<span class="c"># it under the terms of the GNU Affero General Public License as published</span>
<span class="c"># by the Free Software Foundation, either version 3 of the License, or</span>
<span class="c"># (at your option) any later version.</span>
<span class="c">#</span>
<span class="c"># This program is distributed in the hope that it will be useful,</span>
<span class="c"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c"># GNU Affero General Public License for more details.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">gnupg.py</span>
<span class="sd">========</span>
<span class="sd">A Python interface to GnuPG.</span>

<span class="sd">This is a modified version of python-gnupg-0.3.0, which was created by Vinay</span>
<span class="sd">Sajip, which itself is a modification of GPG.py written by Steve Traugott,</span>
<span class="sd">which in turn is a modification of the pycrypto GnuPG interface written by</span>
<span class="sd">A.M. Kuchling.</span>

<span class="sd">This version is patched to exclude calls to :class:`subprocess.Popen([...],</span>
<span class="sd">shell=True)`, and it also attempts to provide sanitization of arguments</span>
<span class="sd">presented to gnupg, in order to avoid potential vulnerabilities.</span>

<span class="sd">:Info: see &lt;https://www.github.com/isislovecruft/python-gnupg&gt;</span>
<span class="sd">:Authors: A.M. Kuchling, Steve Traugott, Vinay Sajip, Isis Lovecruft</span>
<span class="sd">:Date: $Date: 2013-04-04 01:11:01 +0000 (Thursday, April 4, 2013) $</span>
<span class="sd">:Description: Documentation of python-gnupg, a Python module for GnuPG.</span>


<span class="sd">Previous Authors&#39; Documentation</span>
<span class="sd">-------------------------------</span>

<span class="sd">Steve Traugott&#39;s documentation:</span>

<span class="sd">    Portions of this module are derived from A.M. Kuchling&#39;s well-designed</span>
<span class="sd">    GPG.py, using Richard Jones&#39; updated version 1.3, which can be found in</span>
<span class="sd">    the pycrypto CVS repository on Sourceforge:</span>

<span class="sd">    http://pycrypto.cvs.sourceforge.net/viewvc/pycrypto/gpg/GPG.py</span>

<span class="sd">    This module is *not* forward-compatible with amk&#39;s; some of the old</span>
<span class="sd">    interface has changed.  For instance, since I&#39;ve added decrypt</span>
<span class="sd">    functionality, I elected to initialize with a &#39;gpghome&#39; argument instead</span>
<span class="sd">    of &#39;keyring&#39;, so that gpg can find both the public and secret keyrings.</span>
<span class="sd">    I&#39;ve also altered some of the returned objects in order for the caller to</span>
<span class="sd">    not have to know as much about the internals of the result classes.</span>

<span class="sd">    While the rest of ISconf is released under the GPL, I am releasing this</span>
<span class="sd">    single file under the same terms that A.M. Kuchling used for pycrypto.</span>

<span class="sd">    Steve Traugott, stevegt@terraluna.org</span>
<span class="sd">    Thu Jun 23 21:27:20 PDT 2005</span>


<span class="sd">Vinay Sajip&#39;s documentation:</span>

<span class="sd">    This version of the module has been modified from Steve Traugott&#39;s version</span>
<span class="sd">    (see http://trac.t7a.org/isconf/browser/trunk/lib/python/isconf/GPG.py) by</span>
<span class="sd">    Vinay Sajip to make use of the subprocess module (Steve&#39;s version uses</span>
<span class="sd">    os.fork() and so does not work on Windows). Renamed to gnupg.py to avoid</span>
<span class="sd">    confusion with the previous versions.</span>

<span class="sd">    A unittest harness (test_gnupg.py) has also been added.</span>

<span class="sd">    Modifications Copyright (C) 2008-2012 Vinay Sajip. All rights reserved.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s">&quot;Isis Agora Lovecruft&quot;</span>
<span class="n">__module__</span> <span class="o">=</span> <span class="s">&#39;gnupg&#39;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s">&quot;0.4.0&quot;</span>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
    <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">cStringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>

<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">PIPE</span>

<span class="kn">import</span> <span class="nn">codecs</span>
<span class="c">## For AOS, the locale module will need to point to a wrapper around the</span>
<span class="c">## java.util.Locale class.</span>
<span class="c">## See https://github.com/isislovecruft/android-locale-hack</span>
<span class="kn">import</span> <span class="nn">locale</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="kn">from</span> <span class="nn">parsers</span> <span class="kn">import</span> <span class="n">Verify</span><span class="p">,</span> <span class="n">Crypt</span><span class="p">,</span> <span class="n">DeleteResult</span><span class="p">,</span> <span class="n">ImportResult</span>
<span class="kn">from</span> <span class="nn">parsers</span> <span class="kn">import</span> <span class="n">GenKey</span><span class="p">,</span> <span class="n">Sign</span><span class="p">,</span> <span class="n">ListKeys</span><span class="p">,</span> <span class="n">ListPackets</span>
<span class="kn">from</span> <span class="nn">parsers</span> <span class="kn">import</span> <span class="n">_fix_unsafe</span><span class="p">,</span> <span class="n">_sanitise</span><span class="p">,</span> <span class="n">_is_allowed</span><span class="p">,</span> <span class="n">_sanitise_list</span>
<span class="kn">from</span> <span class="nn">util</span>    <span class="kn">import</span> <span class="n">logger</span><span class="p">,</span> <span class="n">_conf</span>

<span class="kn">import</span> <span class="nn">util</span>


<span class="k">def</span> <span class="nf">_copy_data</span><span class="p">(</span><span class="n">instream</span><span class="p">,</span> <span class="n">outstream</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Copy data from one stream to another.</span>

<span class="sd">    :type instream: :class:`io.BytesIO` or :class:`io.StringIO` or file</span>
<span class="sd">    :param instream: A byte stream or open file to read from.</span>
<span class="sd">    :param file outstream: The file descriptor of a tmpfile to write to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sent</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c">#assert (util._is_stream(instream)</span>
        <span class="c">#        or isinstance(instream, file)), &quot;instream not stream or file&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outstream</span><span class="p">,</span> <span class="nb">file</span><span class="p">),</span> <span class="s">&quot;outstream is not a file&quot;</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ae</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">ae</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="s">&#39;encoding&#39;</span><span class="p">):</span>
        <span class="n">enc</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">encoding</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">enc</span> <span class="o">=</span> <span class="s">&#39;ascii&#39;</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">instream</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">sent</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;sending chunk (</span><span class="si">%d</span><span class="s">): </span><span class="si">%r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sent</span><span class="p">,</span> <span class="n">data</span><span class="p">[:</span><span class="mi">256</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">outstream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">outstream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">enc</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&#39;Error sending data: Broken pipe&#39;</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="c"># Can sometimes get &#39;broken pipe&#39; errors even when the</span>
            <span class="c"># data has all been sent</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&#39;Error sending data: Broken pipe&#39;</span><span class="p">)</span>
            <span class="k">break</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">outstream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&#39;Got IOError while trying to close FD outstream&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;closed output, </span><span class="si">%d</span><span class="s"> bytes sent&quot;</span><span class="p">,</span> <span class="n">sent</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_threaded_copy_data</span><span class="p">(</span><span class="n">instream</span><span class="p">,</span> <span class="n">outstream</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Copy data from one stream to another in a separate thread.</span>

<span class="sd">    Wraps ``_copy_data()`` in a :class:`threading.Thread`.</span>

<span class="sd">    :type instream: :class:`io.BytesIO` or :class:`io.StringIO`</span>
<span class="sd">    :param instream: A byte stream to read from.</span>
<span class="sd">    :param file outstream: The file descriptor of a tmpfile to write to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">copy_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_copy_data</span><span class="p">,</span>
                                   <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">instream</span><span class="p">,</span> <span class="n">outstream</span><span class="p">))</span>
    <span class="n">copy_thread</span><span class="o">.</span><span class="n">setDaemon</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;_threaded_copy_data(): </span><span class="si">%r</span><span class="s">, </span><span class="si">%r</span><span class="s">, </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">copy_thread</span><span class="p">,</span>
                 <span class="n">instream</span><span class="p">,</span> <span class="n">outstream</span><span class="p">)</span>
    <span class="n">copy_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">copy_thread</span>

<span class="k">def</span> <span class="nf">_write_passphrase</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">passphrase</span><span class="p">,</span> <span class="n">encoding</span><span class="p">):</span>
    <span class="n">passphrase</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">passphrase</span>
    <span class="n">passphrase</span> <span class="o">=</span> <span class="n">passphrase</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
    <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">passphrase</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;_write_passphrase(): Wrote passphrase.&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="GPG"><a class="viewcode-back" href="../gnupg.html#gnupg.GPG">[docs]</a><span class="k">class</span> <span class="nc">GPG</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Encapsulate access to the gpg executable&quot;&quot;&quot;</span>
    <span class="n">_decode_errors</span> <span class="o">=</span> <span class="s">&#39;strict&#39;</span>

    <span class="n">_result_map</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;crypt&#39;</span><span class="p">:</span> <span class="n">Crypt</span><span class="p">,</span>
                   <span class="s">&#39;delete&#39;</span><span class="p">:</span> <span class="n">DeleteResult</span><span class="p">,</span>
                   <span class="s">&#39;generate&#39;</span><span class="p">:</span> <span class="n">GenKey</span><span class="p">,</span>
                   <span class="s">&#39;import&#39;</span><span class="p">:</span> <span class="n">ImportResult</span><span class="p">,</span>
                   <span class="s">&#39;list&#39;</span><span class="p">:</span> <span class="n">ListKeys</span><span class="p">,</span>
                   <span class="s">&#39;sign&#39;</span><span class="p">:</span> <span class="n">Sign</span><span class="p">,</span>
                   <span class="s">&#39;verify&#39;</span><span class="p">:</span> <span class="n">Verify</span><span class="p">,}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gpgbinary</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">gpghome</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">use_agent</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">keyring</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">secring</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pubring</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">options</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a GnuPG process wrapper.</span>

<span class="sd">        :param str gpgbinary: Name for GnuPG binary executable. If the absolute</span>
<span class="sd">                              path is not given, the evironment variable $PATH</span>
<span class="sd">                              is searched for the executable and checked that</span>
<span class="sd">                              the real uid/gid of the user has sufficient</span>
<span class="sd">                              permissions.</span>
<span class="sd">        :param str gpghome: Full pathname to directory containing the public</span>
<span class="sd">                            and private keyrings. Default is whatever GnuPG</span>
<span class="sd">                            defaults to.</span>
<span class="sd">        :param str keyring: raises :exc:DeprecationWarning. Use :param:pubring.</span>
<span class="sd">        :param str secring: Name of alternative secret keyring file to use. If</span>
<span class="sd">                            left unspecified, this will default to using</span>
<span class="sd">                            &#39;secring.gpg&#39; in the :param:gpghome directory, and</span>
<span class="sd">                            create that file if it does not exist.</span>
<span class="sd">        :param str pubring: Name of alternative public keyring file to use. If</span>
<span class="sd">                            left unspecified, this will default to using</span>
<span class="sd">                            &#39;pubring.gpg&#39; in the :param:gpghome directory, and</span>
<span class="sd">                            create that file if it does not exist.</span>
<span class="sd">        :param list options: A list of additional options to pass to the GPG</span>
<span class="sd">                             binary.</span>
<span class="sd">        :raises: :exc:`RuntimeError` with explanation message if there is a</span>
<span class="sd">                 problem invoking gpg.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">gpghome</span><span class="p">:</span>
            <span class="n">gpghome</span> <span class="o">=</span> <span class="n">_conf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gpghome</span> <span class="o">=</span> <span class="n">_fix_unsafe</span><span class="p">(</span><span class="n">gpghome</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpghome</span><span class="p">:</span>
            <span class="n">util</span><span class="o">.</span><span class="n">_create_gpghome</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gpghome</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;Unsuitable gpg home dir: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">gpghome</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;GPG.__init__(): </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gpgbinary</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">_find_gpgbinary</span><span class="p">(</span><span class="n">gpgbinary</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">keyring</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">DeprecationWarning</span><span class="p">(</span><span class="s">&quot;Option &#39;keyring&#39; changing to &#39;secring&#39;&quot;</span><span class="p">)</span>

        <span class="n">secring</span> <span class="o">=</span> <span class="s">&#39;secring.gpg&#39;</span> <span class="k">if</span> <span class="n">secring</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">_fix_unsafe</span><span class="p">(</span><span class="n">secring</span><span class="p">)</span>
        <span class="n">pubring</span> <span class="o">=</span> <span class="s">&#39;pubring.gpg&#39;</span> <span class="k">if</span> <span class="n">pubring</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">_fix_unsafe</span><span class="p">(</span><span class="n">pubring</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secring</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gpghome</span><span class="p">,</span> <span class="n">secring</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pubring</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gpghome</span><span class="p">,</span> <span class="n">pubring</span><span class="p">)</span>

        <span class="c">#for ring in [self.secring, self.pubring]:</span>
        <span class="c">#    if ring and not os.path.isfile(ring):</span>
        <span class="c">#        with open(ring, &#39;a+&#39;) as ringfile:</span>
        <span class="c">#            ringfile.write(&quot;&quot;)</span>
        <span class="c">#            ringfile.flush()</span>
        <span class="c">#    try:</span>
        <span class="c">#        assert util._has_readwrite(ring), \</span>
        <span class="c">#            (&quot;Need r+w for %s&quot; % ring)</span>
        <span class="c">#    except AssertionError as ae:</span>
        <span class="c">#        logger.debug(ae.message)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">_sanitise</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="k">if</span> <span class="n">options</span> <span class="k">else</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">getpreferredencoding</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="c"># This happens on Jython!</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">encoding</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpghome</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&quot;Got None for self.gpghome&quot;</span>
            <span class="k">assert</span> <span class="n">util</span><span class="o">.</span><span class="n">_has_readwrite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gpghome</span><span class="p">),</span> <span class="p">(</span><span class="s">&quot;Home dir </span><span class="si">%s</span><span class="s"> needs r+w&quot;</span>
                                                       <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpghome</span><span class="p">)</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpgbinary</span><span class="p">,</span> <span class="s">&quot;Could not find gpgbinary </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">full</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span> <span class="s">&quot;&#39;verbose&#39; must be boolean&quot;</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">use_agent</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span> <span class="s">&quot;&#39;use_agent&#39; must be boolean&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="p">(</span><span class="s">&quot;options not formatted: </span><span class="si">%s</span><span class="s">&quot;</span>
                                                  <span class="o">%</span> <span class="n">options</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AssertionError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ae</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;GPG.__init__(): </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">ae</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">ae</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_agent</span> <span class="o">=</span> <span class="n">use_agent</span>

            <span class="n">proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_subprocess</span><span class="p">([</span><span class="s">&quot;--version&quot;</span><span class="p">])</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_map</span><span class="p">[</span><span class="s">&#39;list&#39;</span><span class="p">](</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_collect_output</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">proc</span><span class="o">.</span><span class="n">stdin</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Error invoking gpg: </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span>
                                   <span class="o">%</span> <span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_make_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">passphrase</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a list of command line elements for GPG. The value of ``args``</span>
<span class="sd">        will be appended only if it passes the checks in</span>
<span class="sd">        :func:parsers._sanitise. The ``passphrase`` argument needs to be True</span>
<span class="sd">        if a passphrase will be sent to GPG, else False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gpgbinary</span><span class="p">,</span> <span class="s">&#39;--status-fd 2 --no-tty&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpghome</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--homedir &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpghome</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pubring</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--no-default-keyring --keyring </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">pubring</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">secring</span><span class="p">:</span>
                <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--secret-keyring </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">secring</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">passphrase</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--batch --passphrase-fd 0&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_agent</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--use-agent&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
            <span class="p">[</span><span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">_sanitise_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">))]</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="p">[</span><span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">_sanitise_list</span><span class="p">(</span><span class="n">args</span><span class="p">))]</span>
        <span class="k">return</span> <span class="n">cmd</span>

    <span class="k">def</span> <span class="nf">_open_subprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">passphrase</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open a pipe to a GPG subprocess and return the file objects for</span>
<span class="sd">        communicating with it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_make_args</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">passphrase</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;_open_subprocess(): </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads all the stderr output from GPG, taking notice only of lines</span>
<span class="sd">        that begin with the magic [GNUPG:] prefix.</span>

<span class="sd">        Calls methods on the response object for each valid token found, with</span>
<span class="sd">        the arg being the remainder of the status line.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;[GNUPG:] &#39;</span><span class="p">:</span>
                <span class="c"># Chop off the prefix</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">9</span><span class="p">:]</span>
                <span class="n">L</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">keyword</span> <span class="o">=</span> <span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">L</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">L</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                <span class="n">result</span><span class="o">.</span><span class="n">handle_status</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the contents of the file from GPG&#39;s stdout.&quot;&quot;&quot;</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;chunk: </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">data</span><span class="p">[:</span><span class="mi">256</span><span class="p">])</span>
            <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">util</span><span class="o">.</span><span class="n">_py3k</span><span class="p">:</span>
            <span class="c"># Join using b&#39;&#39; or &#39;&#39;, as appropriate</span>
            <span class="n">result</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_collect_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Drain the subprocesses output streams, writing the collected output</span>
<span class="sd">        to the result. If a writer thread (writing to the subprocess) is given,</span>
<span class="sd">        make sure it&#39;s joined before returning. If a stdin stream is given,</span>
<span class="sd">        close it before returning.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stderr</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">getreader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)(</span><span class="n">process</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_read_response</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>
        <span class="n">rr</span><span class="o">.</span><span class="n">setDaemon</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;stderr reader: </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">rr</span><span class="p">)</span>
        <span class="n">rr</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="n">stdout</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span>
        <span class="n">dr</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_read_data</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>
        <span class="n">dr</span><span class="o">.</span><span class="n">setDaemon</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;stdout reader: </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">dr</span><span class="p">)</span>
        <span class="n">dr</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="n">dr</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">rr</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">writer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">stdin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_handle_io</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">passphrase</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle a call to GPG - pass input data, collect output data.&quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_subprocess</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">passphrase</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">binary</span><span class="p">:</span>
            <span class="n">stdin</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">getwriter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)(</span><span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stdin</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">stdin</span>
        <span class="k">if</span> <span class="n">passphrase</span><span class="p">:</span>
            <span class="n">_write_passphrase</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="n">passphrase</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">_threaded_copy_data</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">stdin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collect_output</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">stdin</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="c">#</span>
    <span class="c"># SIGNATURE METHODS</span>
    <span class="c">#</span>
<div class="viewcode-block" id="GPG.sign"><a class="viewcode-back" href="../gnupg.html#gnupg.GPG.sign">[docs]</a>    <span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a signature for a message or file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="nb">file</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sign_file</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">util</span><span class="o">.</span><span class="n">_is_stream</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">util</span><span class="o">.</span><span class="n">_py3k</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">_make_binary_stream</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sign_file</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Unable to sign message &#39;</span><span class="si">%s</span><span class="s">&#39; with type </span><span class="si">%s</span><span class="s">&quot;</span>
                         <span class="o">%</span> <span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">message</span><span class="p">)))</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
    <span class="k">def</span> <span class="nf">_sign_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">keyid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">passphrase</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">clearsign</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                   <span class="n">detach</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a signature for a  file.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;GPG._sign_file(): </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">binary</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;--sign&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;--sign --armor&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">clearsign</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;--clearsign&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">detach</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s">&quot;Cannot use --clearsign and --detach-sign simultaneously.&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s">&quot;Using default GPG behaviour: --clearsign only.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">detach</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">clearsign</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;--detach-sign&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">keyid</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s">&quot;--default-key </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">keyid</span><span class="p">))</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_map</span><span class="p">[</span><span class="s">&#39;sign&#39;</span><span class="p">](</span><span class="bp">self</span><span class="p">)</span>
        <span class="c">#We could use _handle_io here except for the fact that if the</span>
        <span class="c">#passphrase is bad, gpg bails and you can&#39;t write the message.</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_subprocess</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">passphrase</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stdin</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">stdin</span>
            <span class="k">if</span> <span class="n">passphrase</span><span class="p">:</span>
                <span class="n">_write_passphrase</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="n">passphrase</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">_threaded_copy_data</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">stdin</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&quot;error writing message&quot;</span><span class="p">)</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collect_output</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">stdin</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="GPG.verify"><a class="viewcode-back" href="../gnupg.html#gnupg.GPG.verify">[docs]</a>    <span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify the signature on the contents of the string ``data``.</span>

<span class="sd">        &gt;&gt;&gt; gpg = GPG(gpghome=&quot;keys&quot;)</span>
<span class="sd">        &gt;&gt;&gt; input = gpg.gen_key_input(Passphrase=&#39;foo&#39;)</span>
<span class="sd">        &gt;&gt;&gt; key = gpg.gen_key(input)</span>
<span class="sd">        &gt;&gt;&gt; assert key</span>
<span class="sd">        &gt;&gt;&gt; sig = gpg.sign(&#39;hello&#39;,keyid=key.fingerprint,passphrase=&#39;bar&#39;)</span>
<span class="sd">        &gt;&gt;&gt; assert not sig</span>
<span class="sd">        &gt;&gt;&gt; sig = gpg.sign(&#39;hello&#39;,keyid=key.fingerprint,passphrase=&#39;foo&#39;)</span>
<span class="sd">        &gt;&gt;&gt; assert sig</span>
<span class="sd">        &gt;&gt;&gt; verify = gpg.verify(sig.data)</span>
<span class="sd">        &gt;&gt;&gt; assert verify</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">_make_binary_stream</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="GPG.verify_file"><a class="viewcode-back" href="../gnupg.html#gnupg.GPG.verify_file">[docs]</a>    <span class="k">def</span> <span class="nf">verify_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">data_filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the signature on the contents of a file or file-like</span>
<span class="sd">        object. Can handle embedded signatures as well as detached</span>
<span class="sd">        signatures. If using detached signatures, the file containing the</span>
<span class="sd">        detached signature should be specified as the :param:data_filename.</span>

<span class="sd">        :param file file: A file descriptor object. Its type will be checked</span>
<span class="sd">                          with :func:util._is_file.</span>
<span class="sd">        :param file data_filename: A file containing the GPG signature data for</span>
<span class="sd">                                   :param:file. If given, :param:file is</span>
<span class="sd">                                   verified via this detached signature.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">## attempt to wrap any escape characters in quotes:</span>
        <span class="n">safe_file</span> <span class="o">=</span> <span class="n">_fix_unsafe</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>

        <span class="c">## check that :param:file is actually a file:</span>
        <span class="n">util</span><span class="o">.</span><span class="n">_is_file</span><span class="p">(</span><span class="n">safe_file</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;verify_file: </span><span class="si">%r</span><span class="s">, </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">safe_file</span><span class="p">,</span> <span class="n">data_filename</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_map</span><span class="p">[</span><span class="s">&#39;verify&#39;</span><span class="p">](</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;--verify&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">data_filename</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_io</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">safe_file</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">safe_data_filename</span> <span class="o">=</span> <span class="n">_fix_unsafe</span><span class="p">(</span><span class="n">data_filename</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Handling detached verification&#39;</span><span class="p">)</span>
            <span class="n">fd</span><span class="p">,</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s">&#39;pygpg&#39;</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">safe_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">sf</span><span class="p">:</span>
                <span class="n">contents</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Wrote to temp file: </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">contents</span><span class="p">)</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">safe_data_filename</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_subprocess</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_collect_output</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="c">#</span>
    <span class="c"># KEY MANAGEMENT</span>
    <span class="c">#</span></div>
<div class="viewcode-block" id="GPG.import_keys"><a class="viewcode-back" href="../gnupg.html#gnupg.GPG.import_keys">[docs]</a>    <span class="k">def</span> <span class="nf">import_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Import the key_data into our keyring.</span>

<span class="sd">        &gt;&gt;&gt; import shutil</span>
<span class="sd">        &gt;&gt;&gt; shutil.rmtree(&quot;keys&quot;)</span>
<span class="sd">        &gt;&gt;&gt; gpg = GPG(gpghome=&quot;keys&quot;)</span>
<span class="sd">        &gt;&gt;&gt; input = gpg.gen_key_input()</span>
<span class="sd">        &gt;&gt;&gt; result = gpg.gen_key(input)</span>
<span class="sd">        &gt;&gt;&gt; print1 = result.fingerprint</span>
<span class="sd">        &gt;&gt;&gt; result = gpg.gen_key(input)</span>
<span class="sd">        &gt;&gt;&gt; print2 = result.fingerprint</span>
<span class="sd">        &gt;&gt;&gt; pubkey1 = gpg.export_keys(print1)</span>
<span class="sd">        &gt;&gt;&gt; seckey1 = gpg.export_keys(print1,secret=True)</span>
<span class="sd">        &gt;&gt;&gt; seckeys = gpg.list_keys(secret=True)</span>
<span class="sd">        &gt;&gt;&gt; pubkeys = gpg.list_keys()</span>
<span class="sd">        &gt;&gt;&gt; assert print1 in seckeys.fingerprints</span>
<span class="sd">        &gt;&gt;&gt; assert print1 in pubkeys.fingerprints</span>
<span class="sd">        &gt;&gt;&gt; str(gpg.delete_keys(print1))</span>
<span class="sd">        &#39;Must delete secret key first&#39;</span>
<span class="sd">        &gt;&gt;&gt; str(gpg.delete_keys(print1,secret=True))</span>
<span class="sd">        &#39;ok&#39;</span>
<span class="sd">        &gt;&gt;&gt; str(gpg.delete_keys(print1))</span>
<span class="sd">        &#39;ok&#39;</span>
<span class="sd">        &gt;&gt;&gt; str(gpg.delete_keys(&quot;nosuchkey&quot;))</span>
<span class="sd">        &#39;No such key&#39;</span>
<span class="sd">        &gt;&gt;&gt; seckeys = gpg.list_keys(secret=True)</span>
<span class="sd">        &gt;&gt;&gt; pubkeys = gpg.list_keys()</span>
<span class="sd">        &gt;&gt;&gt; assert not print1 in seckeys.fingerprints</span>
<span class="sd">        &gt;&gt;&gt; assert not print1 in pubkeys.fingerprints</span>
<span class="sd">        &gt;&gt;&gt; result = gpg.import_keys(&#39;foo&#39;)</span>
<span class="sd">        &gt;&gt;&gt; assert not result</span>
<span class="sd">        &gt;&gt;&gt; result = gpg.import_keys(pubkey1)</span>
<span class="sd">        &gt;&gt;&gt; pubkeys = gpg.list_keys()</span>
<span class="sd">        &gt;&gt;&gt; seckeys = gpg.list_keys(secret=True)</span>
<span class="sd">        &gt;&gt;&gt; assert not print1 in seckeys.fingerprints</span>
<span class="sd">        &gt;&gt;&gt; assert print1 in pubkeys.fingerprints</span>
<span class="sd">        &gt;&gt;&gt; result = gpg.import_keys(seckey1)</span>
<span class="sd">        &gt;&gt;&gt; assert result</span>
<span class="sd">        &gt;&gt;&gt; seckeys = gpg.list_keys(secret=True)</span>
<span class="sd">        &gt;&gt;&gt; pubkeys = gpg.list_keys()</span>
<span class="sd">        &gt;&gt;&gt; assert print1 in seckeys.fingerprints</span>
<span class="sd">        &gt;&gt;&gt; assert print1 in pubkeys.fingerprints</span>
<span class="sd">        &gt;&gt;&gt; assert print2 in pubkeys.fingerprints</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">## xxx need way to validate that key_data is actually a valid GPG key</span>
        <span class="c">##     it might be possible to use --list-packets and parse the output</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_map</span><span class="p">[</span><span class="s">&#39;import&#39;</span><span class="p">](</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;import_keys: </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">key_data</span><span class="p">[:</span><span class="mi">256</span><span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">_make_binary_stream</span><span class="p">(</span><span class="n">key_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle_io</span><span class="p">([</span><span class="s">&#39;--import&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;import_keys result: </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="GPG.recv_keys"><a class="viewcode-back" href="../gnupg.html#gnupg.GPG.recv_keys">[docs]</a>    <span class="k">def</span> <span class="nf">recv_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyserver</span><span class="p">,</span> <span class="o">*</span><span class="n">keyids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Import a key from a keyserver</span>

<span class="sd">        &gt;&gt;&gt; import shutil</span>
<span class="sd">        &gt;&gt;&gt; shutil.rmtree(&quot;keys&quot;)</span>
<span class="sd">        &gt;&gt;&gt; gpg = GPG(gpghome=&quot;keys&quot;)</span>
<span class="sd">        &gt;&gt;&gt; result = gpg.recv_keys(&#39;pgp.mit.edu&#39;, &#39;3FF0DB166A7476EA&#39;)</span>
<span class="sd">        &gt;&gt;&gt; assert result</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">safe_keyserver</span> <span class="o">=</span> <span class="n">_fix_unsafe</span><span class="p">(</span><span class="n">keyserver</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_map</span><span class="p">[</span><span class="s">&#39;import&#39;</span><span class="p">](</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">_make_binary_stream</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;--keyserver&#39;</span><span class="p">,</span> <span class="n">keyserver</span><span class="p">,</span> <span class="s">&#39;--recv-keys&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">keyids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">keyids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">safe_keyids</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">_fix_unsafe</span><span class="p">(</span><span class="n">k</span><span class="p">))()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keyids</span><span class="p">])</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;recv_keys: </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">safe_keyids</span><span class="p">)</span>
                <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">safe_keyids</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_handle_io</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;recv_keys result: </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="GPG.delete_keys"><a class="viewcode-back" href="../gnupg.html#gnupg.GPG.delete_keys">[docs]</a>    <span class="k">def</span> <span class="nf">delete_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fingerprints</span><span class="p">,</span> <span class="n">secret</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">which</span><span class="o">=</span><span class="s">&#39;key&#39;</span>
        <span class="k">if</span> <span class="n">secret</span><span class="p">:</span>
            <span class="n">which</span><span class="o">=</span><span class="s">&#39;secret-key&#39;</span>
        <span class="k">if</span> <span class="n">util</span><span class="o">.</span><span class="n">_is_list_or_tuple</span><span class="p">(</span><span class="n">fingerprints</span><span class="p">):</span>
            <span class="n">fingerprints</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fingerprints</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;--batch --delete-</span><span class="si">%s</span><span class="s"> &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">which</span><span class="p">,</span> <span class="n">fingerprints</span><span class="p">)]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_map</span><span class="p">[</span><span class="s">&#39;delete&#39;</span><span class="p">](</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_subprocess</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collect_output</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="GPG.export_keys"><a class="viewcode-back" href="../gnupg.html#gnupg.GPG.export_keys">[docs]</a>    <span class="k">def</span> <span class="nf">export_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyids</span><span class="p">,</span> <span class="n">secret</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;export the indicated keys. &#39;keyid&#39; is anything gpg accepts&quot;&quot;&quot;</span>
        <span class="n">which</span><span class="o">=</span><span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">secret</span><span class="p">:</span>
            <span class="n">which</span><span class="o">=</span><span class="s">&#39;-secret-key&#39;</span>
        <span class="k">if</span> <span class="n">util</span><span class="o">.</span><span class="n">_is_list_or_tuple</span><span class="p">(</span><span class="n">keyids</span><span class="p">):</span>
            <span class="n">keyids</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keyids</span><span class="p">])</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;--armor --export</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">which</span><span class="p">,</span> <span class="n">keyids</span><span class="p">)]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_subprocess</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="c"># gpg --export produces no status-fd output; stdout will be</span>
        <span class="c"># empty in case of failure</span>
        <span class="c">#stdout, stderr = p.communicate()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_map</span><span class="p">[</span><span class="s">&#39;delete&#39;</span><span class="p">](</span><span class="bp">self</span><span class="p">)</span> <span class="c"># any result will do</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collect_output</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;export_keys result: </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_errors</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GPG.list_keys"><a class="viewcode-back" href="../gnupg.html#gnupg.GPG.list_keys">[docs]</a>    <span class="k">def</span> <span class="nf">list_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">secret</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List the keys currently in the keyring.</span>

<span class="sd">        &gt;&gt;&gt; import shutil</span>
<span class="sd">        &gt;&gt;&gt; shutil.rmtree(&quot;keys&quot;)</span>
<span class="sd">        &gt;&gt;&gt; gpg = GPG(gpghome=&quot;keys&quot;)</span>
<span class="sd">        &gt;&gt;&gt; input = gpg.gen_key_input()</span>
<span class="sd">        &gt;&gt;&gt; result = gpg.gen_key(input)</span>
<span class="sd">        &gt;&gt;&gt; print1 = result.fingerprint</span>
<span class="sd">        &gt;&gt;&gt; result = gpg.gen_key(input)</span>
<span class="sd">        &gt;&gt;&gt; print2 = result.fingerprint</span>
<span class="sd">        &gt;&gt;&gt; pubkeys = gpg.list_keys()</span>
<span class="sd">        &gt;&gt;&gt; assert print1 in pubkeys.fingerprints</span>
<span class="sd">        &gt;&gt;&gt; assert print2 in pubkeys.fingerprints</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">which</span><span class="o">=</span><span class="s">&#39;public-keys&#39;</span>
        <span class="k">if</span> <span class="n">secret</span><span class="p">:</span>
            <span class="n">which</span><span class="o">=</span><span class="s">&#39;secret-keys&#39;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="s">&quot;--list-</span><span class="si">%s</span><span class="s"> --fixed-list-mode --fingerprint --with-colons&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">which</span><span class="p">,)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_subprocess</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

        <span class="c"># there might be some status thingumy here I should handle... (amk)</span>
        <span class="c"># ...nope, unless you care about expired sigs or keys (stevegt)</span>

        <span class="c"># Get the response information</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_map</span><span class="p">[</span><span class="s">&#39;list&#39;</span><span class="p">](</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collect_output</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">_decode_errors</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">valid_keywords</span> <span class="o">=</span> <span class="s">&#39;pub uid sec fpr sub&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;line: </span><span class="si">%r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">L</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">L</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">keyword</span> <span class="o">=</span> <span class="n">L</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">valid_keywords</span><span class="p">:</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">keyword</span><span class="p">)(</span><span class="n">L</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="GPG.gen_key"><a class="viewcode-back" href="../gnupg.html#gnupg.GPG.gen_key">[docs]</a>    <span class="k">def</span> <span class="nf">gen_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a key; you might use gen_key_input() to create the control</span>
<span class="sd">        input.</span>

<span class="sd">        &gt;&gt;&gt; gpg = GPG(gpghome=&quot;keys&quot;)</span>
<span class="sd">        &gt;&gt;&gt; input = gpg.gen_key_input()</span>
<span class="sd">        &gt;&gt;&gt; result = gpg.gen_key(input)</span>
<span class="sd">        &gt;&gt;&gt; assert result</span>
<span class="sd">        &gt;&gt;&gt; result = gpg.gen_key(&#39;foo&#39;)</span>
<span class="sd">        &gt;&gt;&gt; assert not result</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;--gen-key --batch&quot;</span><span class="p">]</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_map</span><span class="p">[</span><span class="s">&#39;generate&#39;</span><span class="p">](</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">_make_binary_stream</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle_io</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">key</span>
</div>
<div class="viewcode-block" id="GPG.gen_key_input"><a class="viewcode-back" href="../gnupg.html#gnupg.GPG.gen_key_input">[docs]</a>    <span class="k">def</span> <span class="nf">gen_key_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate GnuPG key(s) through batch file key generation.</span>

<span class="sd">        The GnuPG batch file key generation feature allows unattended key</span>
<span class="sd">        generation by creating a file with special syntax and then providing it</span>
<span class="sd">        to:      gpg --gen-key --batch &lt;batch file&gt;</span>

<span class="sd">        see http://www.gnupg.org/documentation/manuals/gnupg-devel/Unattended-GPG-key-generation.html#Unattended-GPG-key-generation</span>
<span class="sd">        for more details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parms</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>    <span class="c"># skip empty strings</span>
                <span class="n">parms</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="n">parms</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;Key-Type&#39;</span><span class="p">,</span> <span class="s">&#39;RSA&#39;</span><span class="p">)</span>
        <span class="n">parms</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;Key-Length&#39;</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
        <span class="n">parms</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;Name-Real&#39;</span><span class="p">,</span> <span class="s">&quot;Autogenerated Key&quot;</span><span class="p">)</span>
        <span class="n">parms</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;Name-Comment&#39;</span><span class="p">,</span> <span class="s">&quot;Generated by python-gnupg&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;LOGNAME&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">logname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;USERNAME&#39;</span><span class="p">]</span>
        <span class="n">hostname</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
        <span class="n">parms</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;Name-Email&#39;</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">@</span><span class="si">%s</span><span class="s">&quot;</span>
                         <span class="o">%</span> <span class="p">(</span><span class="n">logname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">),</span> <span class="n">hostname</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s">&quot;Key-Type: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">parms</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;Key-Type&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">parms</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="si">%%</span><span class="s">pubring </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">pubring</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="si">%%</span><span class="s">secring </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">secring</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="si">%c</span><span class="s">ommit</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="k">return</span> <span class="n">out</span>

        <span class="c"># Key-Type: RSA</span>
        <span class="c"># Key-Length: 1024</span>
        <span class="c"># Name-Real: ISdlink Server on %s</span>
        <span class="c"># Name-Comment: Created by %s</span>
        <span class="c"># Name-Email: isdlink@%s</span>
        <span class="c"># Expire-Date: 0</span>
        <span class="c"># %commit</span>
        <span class="c">#</span>
        <span class="c">#</span>
        <span class="c"># Key-Type: DSA</span>
        <span class="c"># Key-Length: 1024</span>
        <span class="c"># Subkey-Type: ELG-E</span>
        <span class="c"># Subkey-Length: 1024</span>
        <span class="c"># Name-Real: Joe Tester</span>
        <span class="c"># Name-Comment: with stupid passphrase</span>
        <span class="c"># Name-Email: joe@foo.bar</span>
        <span class="c"># Expire-Date: 0</span>
        <span class="c"># Passphrase: abc</span>
        <span class="c"># %pubring foo.pub</span>
        <span class="c"># %secring foo.sec</span>
        <span class="c"># %commit</span>

    <span class="c">#</span>
    <span class="c"># ENCRYPTION</span>
    <span class="c">#</span></div>
<div class="viewcode-block" id="GPG.encrypt_file"><a class="viewcode-back" href="../gnupg.html#gnupg.GPG.encrypt_file">[docs]</a>    <span class="k">def</span> <span class="nf">encrypt_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">recipients</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">always_trust</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">passphrase</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">armor</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">symmetric</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Encrypt the message read from ``file``.</span>

<span class="sd">        :type file: file or :class:BytesIO</span>
<span class="sd">        :param file: The file or bytestream to encrypt.</span>
<span class="sd">        :type recipients: str or list or tuple</span>
<span class="sd">        :param recipients: The recipients to encrypt to. Recipients may be</span>
<span class="sd">                           specified by UID or keyID/fingerprint.</span>
<span class="sd">        :param str sign: The keyID to use for signing, i.e.</span>
<span class="sd">                         &quot;gpg --sign --default-key A3ADB67A2CDB8B35 ...&quot;</span>
<span class="sd">        :param bool always_trust: If True, ignore trust warnings on recipient</span>
<span class="sd">                                  keys. If False, display trust warnings.</span>
<span class="sd">                                  (default: False)</span>
<span class="sd">        :param bool passphrase: If True, use the stored passphrase for our</span>
<span class="sd">                                secret key.</span>

<span class="sd">        :param bool armor: If True, ascii armor the encrypted output; if False,</span>
<span class="sd">                           the encrypted output will be in binary</span>
<span class="sd">                           format. (default: True)</span>

<span class="sd">        :param str output: The output file to write to. If not specified, the</span>
<span class="sd">                           encrypted output is returned, and thus should be</span>
<span class="sd">                           stored as an object in Python. For example:</span>

<span class="sd">        &gt;&gt;&gt; gpg = gnupg.GPG(gpghome=&#39;./tmp_test&#39;)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">output</span><span class="p">:</span>  <span class="c"># write the output to a file with the specified name</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="c"># to avoid overwrite confirmation message</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--output &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">output</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;--encrypt&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">symmetric</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;--symmetric&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;--encrypt&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">util</span><span class="o">.</span><span class="n">_is_list_or_tuple</span><span class="p">(</span><span class="n">recipients</span><span class="p">):</span>
                <span class="n">recipients</span> <span class="o">=</span> <span class="p">(</span><span class="n">recipients</span><span class="p">,)</span>
            <span class="k">for</span> <span class="n">recipient</span> <span class="ow">in</span> <span class="n">recipients</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--recipient &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">recipient</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">armor</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--armor&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sign</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--sign --default-key &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">sign</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">always_trust</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;--always-trust&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_map</span><span class="p">[</span><span class="s">&#39;crypt&#39;</span><span class="p">](</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle_io</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">passphrase</span><span class="o">=</span><span class="n">passphrase</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;encrypt result: </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="GPG.encrypt"><a class="viewcode-back" href="../gnupg.html#gnupg.GPG.encrypt">[docs]</a>    <span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">recipients</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Encrypt the message contained in ``data`` to ``recipients``.</span>

<span class="sd">        &gt;&gt;&gt; import shutil</span>
<span class="sd">        &gt;&gt;&gt; if os.path.exists(&quot;keys&quot;):</span>
<span class="sd">        ...     shutil.rmtree(&quot;keys&quot;)</span>
<span class="sd">        &gt;&gt;&gt; gpg = GPG(gpghome=&quot;keys&quot;)</span>
<span class="sd">        &gt;&gt;&gt; input = gpg.gen_key_input(passphrase=&#39;foo&#39;)</span>
<span class="sd">        &gt;&gt;&gt; result = gpg.gen_key(input)</span>
<span class="sd">        &gt;&gt;&gt; print1 = result.fingerprint</span>
<span class="sd">        &gt;&gt;&gt; input = gpg.gen_key_input()</span>
<span class="sd">        &gt;&gt;&gt; result = gpg.gen_key(input)</span>
<span class="sd">        &gt;&gt;&gt; print2 = result.fingerprint</span>
<span class="sd">        &gt;&gt;&gt; result = gpg.encrypt(&quot;hello&quot;,print2)</span>
<span class="sd">        &gt;&gt;&gt; message = str(result)</span>
<span class="sd">        &gt;&gt;&gt; assert message != &#39;hello&#39;</span>
<span class="sd">        &gt;&gt;&gt; result = gpg.decrypt(message)</span>
<span class="sd">        &gt;&gt;&gt; assert result</span>
<span class="sd">        &gt;&gt;&gt; str(result)</span>
<span class="sd">        &#39;hello&#39;</span>
<span class="sd">        &gt;&gt;&gt; result = gpg.encrypt(&quot;hello again&quot;,print1)</span>
<span class="sd">        &gt;&gt;&gt; message = str(result)</span>
<span class="sd">        &gt;&gt;&gt; result = gpg.decrypt(message,passphrase=&#39;bar&#39;)</span>
<span class="sd">        &gt;&gt;&gt; result.status in (&#39;decryption failed&#39;, &#39;bad passphrase&#39;)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; assert not result</span>
<span class="sd">        &gt;&gt;&gt; result = gpg.decrypt(message,passphrase=&#39;foo&#39;)</span>
<span class="sd">        &gt;&gt;&gt; result.status == &#39;decryption ok&#39;</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; str(result)</span>
<span class="sd">        &#39;hello again&#39;</span>
<span class="sd">        &gt;&gt;&gt; result = gpg.encrypt(&quot;signed hello&quot;,print2,sign=print1,passphrase=&#39;foo&#39;)</span>
<span class="sd">        &gt;&gt;&gt; result.status == &#39;encryption ok&#39;</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; message = str(result)</span>
<span class="sd">        &gt;&gt;&gt; result = gpg.decrypt(message)</span>
<span class="sd">        &gt;&gt;&gt; result.status == &#39;decryption ok&#39;</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; assert result.fingerprint == print1</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">_make_binary_stream</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encrypt_file</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">recipients</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="GPG.decrypt"><a class="viewcode-back" href="../gnupg.html#gnupg.GPG.decrypt">[docs]</a>    <span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decrypt the contents of a string or file-like object :param:message .</span>

<span class="sd">        :param message: A string or file-like object to decrypt.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">_make_binary_stream</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decrypt_file</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="GPG.decrypt_file"><a class="viewcode-back" href="../gnupg.html#gnupg.GPG.decrypt_file">[docs]</a>    <span class="k">def</span> <span class="nf">decrypt_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">always_trust</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">passphrase</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">output</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decrypt the contents of a file-like object :param:file .</span>

<span class="sd">        :param file: A file-like object to decrypt.</span>
<span class="sd">        :param always_trust: Instruct GnuPG to ignore trust checks.</span>
<span class="sd">        :param passphrase: The passphrase for the secret key used for decryption.</span>
<span class="sd">        :param output: A file to write the decrypted output to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;--decrypt&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">output</span><span class="p">:</span>  <span class="c"># write the output to a file with the specified name</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="c"># to avoid overwrite confirmation message</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--output &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">output</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">always_trust</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;--always-trust&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_map</span><span class="p">[</span><span class="s">&#39;crypt&#39;</span><span class="p">](</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle_io</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">passphrase</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;decrypt result: </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

</div></div>
<div class="viewcode-block" id="GPGWrapper"><a class="viewcode-back" href="../gnupg.html#gnupg.GPGWrapper">[docs]</a><span class="k">class</span> <span class="nc">GPGWrapper</span><span class="p">(</span><span class="n">GPG</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a temporary class for handling GPG requests, and should be</span>
<span class="sd">    replaced by a more general class used throughout the project.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gpgbinary</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">gnupghome</span><span class="o">=</span><span class="n">_conf</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_agent</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">keyring</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GPGWrapper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">gnupghome</span><span class="o">=</span><span class="n">gnupghome</span><span class="p">,</span>
                                         <span class="n">gpgbinary</span><span class="o">=</span><span class="n">gpgbinary</span><span class="p">,</span>
                                         <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                                         <span class="n">use_agent</span><span class="o">=</span><span class="n">use_agent</span><span class="p">,</span>
                                         <span class="n">keyring</span><span class="o">=</span><span class="n">keyring</span><span class="p">,</span>
                                         <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result_map</span><span class="p">[</span><span class="s">&#39;list-packets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ListPackets</span>

<div class="viewcode-block" id="GPGWrapper.find_key_by_email"><a class="viewcode-back" href="../gnupg.html#gnupg.GPGWrapper.find_key_by_email">[docs]</a>    <span class="k">def</span> <span class="nf">find_key_by_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">secret</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find user&#39;s key based on their email.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_keys</span><span class="p">(</span><span class="n">secret</span><span class="o">=</span><span class="n">secret</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">key</span><span class="p">[</span><span class="s">&#39;uids&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">key</span>
        <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="s">&quot;GnuPG public key for email </span><span class="si">%s</span><span class="s"> not found!&quot;</span> <span class="o">%</span> <span class="n">email</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GPGWrapper.find_key_by_subkey"><a class="viewcode-back" href="../gnupg.html#gnupg.GPGWrapper.find_key_by_subkey">[docs]</a>    <span class="k">def</span> <span class="nf">find_key_by_subkey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subkey</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">key</span><span class="p">[</span><span class="s">&#39;subkeys&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">sub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">subkey</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">key</span>
        <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span>
            <span class="s">&quot;GnuPG public key for subkey </span><span class="si">%s</span><span class="s"> not found!&quot;</span> <span class="o">%</span> <span class="n">subkey</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GPGWrapper.find_key_by_keyid"><a class="viewcode-back" href="../gnupg.html#gnupg.GPGWrapper.find_key_by_keyid">[docs]</a>    <span class="k">def</span> <span class="nf">find_key_by_keyid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyid</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">keyid</span> <span class="o">==</span> <span class="n">key</span><span class="p">[</span><span class="s">&#39;keyid&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">key</span>
        <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span>
            <span class="s">&quot;GnuPG public key for subkey </span><span class="si">%s</span><span class="s"> not found!&quot;</span> <span class="o">%</span> <span class="n">subkey</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GPGWrapper.encrypt"><a class="viewcode-back" href="../gnupg.html#gnupg.GPGWrapper.encrypt">[docs]</a>    <span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">recipient</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">always_trust</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">passphrase</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">symmetric</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Encrypt data using GPG.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># TODO: devise a way so we don&#39;t need to &quot;always trust&quot;.</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">GPGWrapper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">recipient</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="n">sign</span><span class="p">,</span>
                                               <span class="n">always_trust</span><span class="o">=</span><span class="n">always_trust</span><span class="p">,</span>
                                               <span class="n">passphrase</span><span class="o">=</span><span class="n">passphrase</span><span class="p">,</span>
                                               <span class="n">symmetric</span><span class="o">=</span><span class="n">symmetric</span><span class="p">,</span>
                                               <span class="n">cipher_algo</span><span class="o">=</span><span class="s">&#39;AES256&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GPGWrapper.decrypt"><a class="viewcode-back" href="../gnupg.html#gnupg.GPGWrapper.decrypt">[docs]</a>    <span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">always_trust</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">passphrase</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decrypt data using GPG.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># TODO: devise a way so we don&#39;t need to &quot;always trust&quot;.</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">GPGWrapper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
                                               <span class="n">always_trust</span><span class="o">=</span><span class="n">always_trust</span><span class="p">,</span>
                                               <span class="n">passphrase</span><span class="o">=</span><span class="n">passphrase</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GPGWrapper.send_keys"><a class="viewcode-back" href="../gnupg.html#gnupg.GPGWrapper.send_keys">[docs]</a>    <span class="k">def</span> <span class="nf">send_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyserver</span><span class="p">,</span> <span class="o">*</span><span class="n">keyids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send keys to a keyserver</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_map</span><span class="p">[</span><span class="s">&#39;list&#39;</span><span class="p">](</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">gnupg</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;send_keys: </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">keyids</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">gnupg</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">_make_binary_stream</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;--keyserver&#39;</span><span class="p">,</span> <span class="n">keyserver</span><span class="p">,</span> <span class="s">&#39;--send-keys&#39;</span><span class="p">]</span>
        <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">keyids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle_io</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">gnupg</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;send_keys result: </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="GPGWrapper.encrypt_file"><a class="viewcode-back" href="../gnupg.html#gnupg.GPGWrapper.encrypt_file">[docs]</a>    <span class="k">def</span> <span class="nf">encrypt_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">recipients</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">always_trust</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">passphrase</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">armor</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">symmetric</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                     <span class="n">cipher_algo</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">&quot;Encrypt the message read from the file-like object &#39;file&#39;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;--encrypt&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">symmetric</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;--symmetric&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cipher_algo</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--cipher-algo </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">cipher_algo</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;--encrypt&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">util</span><span class="o">.</span><span class="n">_is_list_or_tuple</span><span class="p">(</span><span class="n">recipients</span><span class="p">):</span>
                <span class="n">recipients</span> <span class="o">=</span> <span class="p">(</span><span class="n">recipients</span><span class="p">,)</span>
            <span class="k">for</span> <span class="n">recipient</span> <span class="ow">in</span> <span class="n">recipients</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--recipient &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">recipient</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">armor</span><span class="p">:</span>  <span class="c"># create ascii-armored output - set to False for binary</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--armor&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output</span><span class="p">:</span>  <span class="c"># write the output to a file with the specified name</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>  <span class="c"># to avoid overwrite confirmation message</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--output &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">output</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sign</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--sign --default-key &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">sign</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">always_trust</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;--always-trust&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_map</span><span class="p">[</span><span class="s">&#39;crypt&#39;</span><span class="p">](</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle_io</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">passphrase</span><span class="o">=</span><span class="n">passphrase</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;encrypt result: </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="GPGWrapper.list_packets"><a class="viewcode-back" href="../gnupg.html#gnupg.GPGWrapper.list_packets">[docs]</a>    <span class="k">def</span> <span class="nf">list_packets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;--list-packets&quot;</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_map</span><span class="p">[</span><span class="s">&#39;list-packets&#39;</span><span class="p">](</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle_io</span><span class="p">(</span><span class="n">args</span><span class="p">,</span>
                        <span class="n">util</span><span class="o">.</span><span class="n">_make_binary_stream</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">),</span>
                        <span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="GPGWrapper.encrypted_to"><a class="viewcode-back" href="../gnupg.html#gnupg.GPGWrapper.encrypted_to">[docs]</a>    <span class="k">def</span> <span class="nf">encrypted_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the key to which raw_data is encrypted to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># TODO: make this support multiple keys.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_packets</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span>
                <span class="s">&quot;Content is not encrypted to a GnuPG key!&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_key_by_keyid</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_key_by_subkey</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GPGWrapper.is_encrypted_sym"><a class="viewcode-back" href="../gnupg.html#gnupg.GPGWrapper.is_encrypted_sym">[docs]</a>    <span class="k">def</span> <span class="nf">is_encrypted_sym</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_packets</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">need_passphrase_sym</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GPGWrapper.is_encrypted_asym"><a class="viewcode-back" href="../gnupg.html#gnupg.GPGWrapper.is_encrypted_asym">[docs]</a>    <span class="k">def</span> <span class="nf">is_encrypted_asym</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_packets</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GPGWrapper.is_encrypted"><a class="viewcode-back" href="../gnupg.html#gnupg.GPGWrapper.is_encrypted">[docs]</a>    <span class="k">def</span> <span class="nf">is_encrypted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_encrypted_asym</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_encrypted_sym</span><span class="p">()</span></div></div>
</pre></div>

      </div>
      <div class="bottomnav">
      
        <p>
        <a class="uplink" href="../index.html">Contents</a>
        </p>

      </div>

    <div class="footer">
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>